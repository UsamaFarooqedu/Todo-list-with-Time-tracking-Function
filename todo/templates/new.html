{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Add Task</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap 3 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous" />

    <!-- Custom Styles -->
    <style>
      body {
        background: #f8f9fa;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      h2,
      h3 {
        color: #007bff;
        font-weight: 600;
        margin-bottom: 15px;
      }
      
      form {
        background-color: rgb(166, 244, 247);
        padding: 25px 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 40px;
      }
      
      label {
        font-weight: 600;
        color: #333;
      }
      
      .form-control {
        border-radius: 6px;
        border: 1px solidrgb(196, 150, 238);
      }
      
      .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
      }
      
      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        transition: all 0.3s ease-in-out;
      }
      
      .btn-primary:hover {
        background-color: #0056b3;
      }
      
      .table th {
        background-color: #007bff;
        color: white;
        vertical-align: middle;
      }
      
      .table td {
        vertical-align: middle;
      }
      
      .countdown {
        font-weight: bold;
        color: #dc3545;
      }
      
      .container {
        padding-top: 70px;
        padding-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="rows justify-content-center py-20">
      <ul class="nav nav-pills nav-fill gap-2 p-1 small bg-primary rounded-5 shadow-sm" id="pillNav2" role="tablist" style="--bs-nav-link-color: var(--bs-white); --bs-nav-pills-link-active-color: var(--bs-primary); --bs-nav-pills-link-active-bg: var(--bs-white);">
        <li class="nav-item" role="presentation">
          <a href="{% url 'index' %}" class="nav-link rounded-5" role="tab">Home</a>
        </li>

        <li class="nav-item" role="presentation">
          <a href="{% url 'new' %}" class="nav-link rounded-5" role="tab">Todo App</a>
        </li>

        <li class="nav-item" role="presentation">
          <a href="{% url 'list_view' %}" class="nav-link rounded-5" role="tab">All Task</a>
        </li>

        <li class="nav-item" role="presentation">
          <a href="{% url 'login' %}" class="nav-link rounded-5" role="tab">Profile</a>
        </li>
      </ul>
    </div>

    <div class="container text-center">
      <h2>Add Task</h2>

      <!-- Task Form -->
      <form class="form-horizontal center-block" style="max-width: 600px;" method="POST" action="">
        {% csrf_token %}
        <div class="form-group">
          <label for="title" class="control-label">Title:</label>
          <input type="text" class="form-control" id="title" name="title" placeholder="Enter Title" required />
        </div>

        <div class="form-group">
          <label for="description" class="control-label">Description:</label>
          <textarea class="form-control" id="description" name="description" rows="4" placeholder="Enter Description" required></textarea>
        </div>

        <div class="form-group">
          <label for="completion_time" class="control-label">Completion Time:</label>
          <input type="datetime-local" class="form-control" id="completion_time" name="completion_time" required />
        </div>

        <div class="form-group">
          {% if user.is_authenticated %}
            <button type="submit" class="btn btn-primary btn-block">Submit</button>
          {% else %}
            <div class="alert alert-warning mt-3">
              You must <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">login</a>
              to add new tasks.
            </div>
          {% endif %}
        </div>
      </form>

      <!-- Task List -->
      <h3>All Tasks</h3>
      <div class="table-responsive center-block" style="max-width: 900px;">
        <table class="table table-bordered text-center">
          <thead>
            <tr>
              <th>No.</th>
              <th>Title</th>
              <th>Description</th>
              <th>Time Left</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ task.title }}</td>
                <td>{{ task.description }}</td>
                <td>
                  {% if task.completion_time %}
                    <span class="countdown" data-time="{{ task.completion_time|date:'Y-m-d\\TH:i:s' }}"></span>
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'edit_task' task.id %}" class="btn btn-warning btn-sm">Edit</a>
                  <a href="{% url 'delete_task' task.id %}" class="btn btn-danger btn-sm">Delete</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5">No tasks yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- JavaScript Countdown -->
    <script>
      function updateCountdowns() {
        const elements = document.querySelectorAll('.countdown')
        const now = new Date().getTime()
      
        elements.forEach((el) => {
          const target = new Date(el.dataset.time).getTime()
          const diff = target - now
      
          if (diff <= 0) {
            el.innerText = 'Expired'
            el.classList.add('text-muted')
          } else {
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60))
            const secs = Math.floor((diff % (1000 * 60)) / 1000)
            const hrs = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))
            const days = Math.floor(diff / (1000 * 60 * 60 * 24))
            el.innerText = `${days}d ${hrs}h ${mins}m ${secs}s`
          }
        })
      }
      
      setInterval(updateCountdowns, 1000)
      updateCountdowns() // Initial render
    </script>
  </body>
</html>
